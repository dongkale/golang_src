{{template "include/popup_base.html" .}}

{{define "body"}}

<style type="text/css">
body {
	background-color:#1b1d21
}
.video-overlay0 {
	position: absolute;
	top:186px;    	
	left:287px;	
	width:450px;
	height:800px;
	z-index: 1;
	background-color: rgba(0, 0, 0, 0.46);
}
.video-overlay1 {
	position: absolute;
	top:186px; 
	left:871px;	
	width:205px;
	height:153px;
	z-index: 2;
	color: #353941;
	background-color: rgba(0, 0, 0, 0.46);
}
.video-overlay2 {
	position: absolute;
	top:345px; 
	left:871px;	
	width:205px;
	height:153px;
	z-index: 2;
	color: #353941;
	background-color: rgba(0, 0, 0, 0.46);
}
.video-overlay3 {
	position: absolute;
	top:504px;  
	left:871px;	
	width:205px;
	height:153px;
	z-index: 2;
	color: #353941;
	background-color: rgba(0, 0, 0, 0.46);
}
.video-overlay4 {
	position: absolute;
	top:663px;
	left:871px;	
	width:205px;
	height:153px;
	z-index: 2;
	color: #353941;
	background-color: rgba(0, 0, 0, 0.46);
}
.video-overlay5 {
	position: absolute;
	top:822px;
	left:871px;
	width:205px;
	height:153px;
	z-index: 2;
	color: #353941;
	background-color: rgba(0, 0, 0, 0.46);
}
.title-overlay0 {
	position: absolute;
	top: 186px; 
    left: 287px;	
    margin: 10px;
    padding: 5px 5px;
    font-size: 15px;
    font-family: Helvetica;
    color: #FFF;    
	z-index: 65535;
	background-color: rgba(50, 50, 50, 0.3);
}		
.title-overlay1 {
	position: absolute;
    top: 186px;
	left: 871px;
    margin: 10px;
    padding: 5px 5px;
    font-size: 15px;
    font-family: Helvetica;
    color: #FFF;   
	z-index: 65535; 
	background-color: rgba(50, 50, 50, 0.3);
}		
.title-overlay2 {
	position: absolute;
    top: 345px;
	left: 871px;
    margin: 10px;
    padding: 5px 5px;
    font-size: 15px;
    font-family: Helvetica;
    color: #FFF;   
	z-index: 65535; 
	background-color: rgba(50, 50, 50, 0.3);
}		
.title-overlay3 {
	position: absolute;
    top: 504px;
	left: 871px;
    margin: 10px;
    padding: 5px 5px;
    font-size: 15px;
    font-family: Helvetica;
    color: #FFF;   
	z-index: 65535; 
	background-color: rgba(50, 50, 50, 0.3);
}		
.title-overlay4 {
	position: absolute;
    top: 663px;
	left: 871px;
    margin: 10px;
    padding: 5px 5px;
    font-size: 15px;
    font-family: Helvetica;
    color: #FFF;   
	z-index: 65535; 
	background-color: rgba(50, 50, 50, 0.3);
}		
.title-overlay5 {
	position: absolute;
    top: 822px;
	left: 871px;
    margin: 10px;
    padding: 5px 5px;
    font-size: 15px;
    font-family: Helvetica;
    color: #FFF;   
	z-index: 65535; 
	background-color: rgba(50, 50, 50, 0.3);
}

#btn1{ 	
    margin-right:-7px; 
    margin-bottom:-1px; 
} 
#btn_group button{ 
    border: 1px solid gray;
    background-color: rgba(0,0,0,0); 
    color: gray; 
    padding: 5px; 
	left: 1105px;	
    width:81px;
    height:84px;
}
a.btnDelete {
	display:inline-block;
	margin-top:15px;
	text-decoration:underline;
	font-size:13px;
	color:#878d91
}
video{ 
	transform: rotateY(180deg); 
	-webkit-transform:rotateY(180deg); /* Safari and Chrome */ 
	-moz-transform:rotateY(180deg); /* Firefox */ 
}
</style>

<!-- svg -->
<!-- <div class="hWrap">  -->
<!-- 	<div class="header">  -->
<!-- 		<h1><a href="/"><img src="/static/images/logo-admin-top.png" alt="직감 기업관리자"></a></h1>  -->		
<!-- 	</div>  -->
<!-- </div>  -->

<!-- Remote Monster load sdk -->
<!-- <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/@remotemonster/sdk"></script> -->
<script src="https://cdn.jsdelivr.net/npm/@remotemonster/sdk/remon.min.js"></script>

<script src="/static/js/remoteMonster.js"></script>


<img src="/static/images/logo-admin-top-white.png" srcset="/static/images/logo-admin-top-white@2x.png 2x,/static/images/logo-admin-top-white@3x.png 3x" class="Logo_admin_top_white">

<button class="top_title" onclick="exitWindowPop();"><img src="/static/images/ic-topbar-live-tip.png" srcset="/static/images/ic-topbar-live-tip@2x.png 2x, /static/images/ic-topbar-live-tip@3x.png 3x" class="ic_topbar_live_tip">나가기</button>




<div class="video list">
	
</div>

<span class="profileImg"><img src="{{.PtoPath}}" onerror="this.src='/static/images/img-profile-empty-02@3x.png'" width="40" height="40" alt="프로필이미지"></span>
<a id="elapse_time" class="elapse_time" style="color:#FFF;width:50px;height:50px;font-size:35px;">00:00:00</a> 


<div id="btn_group"> 	
	<button onclick="exitWindowPop();"><img src="/static/images/ic-topbar-live-close-end@2x.png" alt="">나가기</button>
	<button onclick="closeWindowPop();"><img src="/static/images/ic-topbar-live-close-alone@2x.png" alt="">종료하기</button>	
</div>

<!-- 나가기 팝업 -->
<div class="popupWrap" id="live_exit_pop">
	<div class="popLayer">
		<div class="popCont">
			<p class="tit">정말 나가시겠습니까?</p>			
		</div>
		<div class="btnSet">
			<a href="javascript:void(0);" class="btn" onclick="closePopup()">취소</a>
			<a href="javascript:void(0);" class="btn type_red" id="btn_live_exit">나가기</a>
		</div>
	</div>
	<span class="cover"></span>
</div>
<!-- 나가기 팝업 -->

<!-- 종료 팝업 -->
<div class="popupWrap" id="live_close_pop">
	<div class="popLayer">
		<div class="popCont">
			<p class="tit">정말 종료하시겠습니까?</p>			
		</div>
		<div class="btnSet">
			<a href="javascript:void(0);" class="btn" onclick="closePopup()">취소</a>
			<a href="javascript:void(0);" class="btn type_red" id="btn_live_close">종료</a>
		</div>
	</div>
	<span class="cover"></span>
</div>
<!-- 종료 팝업 -->

<script>
	//var is_valid = {{.IsValid}};
	var entp_mem_no = {{.EntpMemNo}};
	var entp_mem_sn = {{.SMemSn}};
	var pp_mem_no = {{.PpMemNo}};		
	var pp_mem_nm = {{.PpMemNm}};		
	var recrut_sn = {{.RecrutSn}};
	var live_sn = {{.pLiveSn}};
	var member_list = {{.LiveMemList}};	
	var member_list_cnt =  member_list.length;
	var remon_list_cnt =  member_list_cnt + 1;	// 구직자 + 맴버 인원수

	var pto_path = {{.PtoPath}};

	console.log('*******************************' + pto_path);

	var lemonMembers = {};		// 기업 유저
	var lemonPerson = {};		// 개인 유저
	
	// console.log("====== entp_mem_no == " + entp_mem_no);
	// console.log("====== pp_mem_no == " + pp_mem_no);
	// console.log("====== pp_mem_nm == " + pp_mem_nm);
	// console.log("====== recrut_sn == " + recrut_sn);
	// console.log("====== entp_mem_sn == " + entp_mem_sn);	
	
	function initHtml() {
		
		//style="position: absolute;top:186px;left:287px;width:450px;height:800px;z-index: 1;background-color: rgba(0, 0, 0, 0.46);"

		//style="position: absolute;top: 186px;left: 287px;margin: 10px;padding: 5px 5px;font-size: 15px;font-family: Helvetica;color: #FFF;z-index: 65535;background-color: rgba(50, 50, 50, 0.3);"

		var vd_html = `<video class=\"video-overlay0\" id=\"remoteVideo${0}\" autoplay></video>`
		$(".video.list").append(vd_html);			
	
		var vd_t_html = `<div class=\"title-overlay0\">${pp_mem_nm}</div>`
		$(".video.list").append(vd_t_html);			

		var vd_m_html = `<button type="button" id=\"remoteMute${0}\">Mute</button>`
		$(".video.list").append(vd_m_html);			
		
		// var vd_html = `<video class=\"video-overlay0\" id=\"remoteVideo${0}\" autoplay muted></video>`
		// vd_html += `<div class=\"title-overlay0\">${pp_mem_nm}</video>`
		// $(".video.list").append(vd_html);			

		console.log(`====== vd_html(${pp_mem_nm}): ${vd_html}`);		
	
		// 면접자(기업)
		var num = 1;
		var my_num;
		for (var i = 0; i < member_list.length; i++) {
			
			if (entp_mem_sn == member_list[i].LmPpChrgSn) {	// 본인

				vd_html   = `<video class=\"video-overlay${num}\" id=\"localVideo\" autoplay></video>`
				vd_t_html = `<div class=\"title-overlay${num}\">${member_list[i].LmPpChrgBpNm} ${member_list[i].LmPpChrgNm}</div>`
				vd_m_html = `<button type="button" id=\"localMute\">Mute</button>`

				// vd_html = `<video class=\"video-overlay${num}\" id=\"localVideo\" autoplay muted></video>`
				// vd_html += `<div class=\"title-overlay${num}\">${member_list[i].LmPpChrgBpNm} ${member_list[i].LmPpChrgNm}</video>`

				my_num = num;

			} else {	// 원격자

				vd_html   = `<video class=\"video-overlay${num}\" id=\"remoteVideo${num}\" autoplay></video>`
				vd_t_html = `<div class=\"title-overlay${num}\">${member_list[i].LmPpChrgBpNm} ${member_list[i].LmPpChrgNm}</div>`
				vd_m_html = `<button type="button" id=\"remoteMute${num}\">Mute</button>`

				// vd_html = `<video class=\"video-overlay${num}\" id=\"remoteVideo${num}\" autoplay muted></video>`
				// vd_html += `<div class=\"title-overlay${num}\">${member_list[i].LmPpChrgBpNm} ${member_list[i].LmPpChrgNm}</video>`
			}

			$(".video.list").append(vd_html);
			$(".video.list").append(vd_t_html);
			$(".video.list").append(vd_m_html);
			num++;		
			
			//console.log(`====== member: ${member_list[i].LmPpChrgGbnCd}, ${member_list[i].LmPpChrgNm}, ${member_list[i].LmPpChrgBpNm}, ${member_list[i].LmPpChrgSn}`);		
			console.log(`====== (${member_list[i].LmPpChrgNm}): ${vd_html}`);		
		}
	}

	function initRemoteMonster() {
		
		//LiveChNo”:“E2018102500001_2019110644_P2019082300298_201912091308002 => 지원하는 기업회원번호_ 공고번호_개인회원번호_라이브채팅방 번호	
		
		var base_channel = entp_mem_no + '_' + recrut_sn + '_' + pp_mem_no + '_' + live_sn;			
		
		lemonPerson = new RemoteMonster(
				{
					channel: base_channel + '_' + entp_mem_sn + '_' + '0000',
					remoteVideo: '#remoteVideo' + '0',
					localVideo: '#localVideo',
					num: '0000',
					//remoteVideoId: 'remoteVideo' + '0',
					//localVideoId: 'localVideo',
					remoteMuteId: 'remoteMute' + '0',
					localMuteId: 'localMute',
				});	 
			
		var num = 1;
		for (var i = 0; i < member_list.length; i++) {
			
			if (member_list[i].LmPpChrgSn !== entp_mem_sn) {			

				lemonMembers[member_list[i].LmPpChrgSn] = new RemoteMonster(
					{
						channel: base_channel + '_' + getChannel(entp_mem_sn, member_list[i].LmPpChrgSn),
						remoteVideo: '#remoteVideo' + num,
						localVideo: '#localVideo',
						num: member_list[i].LmPpChrgSn,
						//remoteVideoId: 'remoteVideo' + num,
						//localVideoId: 'localVideo',
						remoteMuteId: 'remoteMute' + num,
						localMuteId: 'localMute',
					});	 
				
				console.log("====== 면접자 == : " + lemonMembers[member_list[i].LmPpChrgSn].roomName);
			}
			
			console.log("====== num : " + num );
			console.log(`====== member: ${member_list[i].LmPpChrgGbnCd}, ${member_list[i].LmPpChrgNm}, ${member_list[i].LmPpChrgBpNm}, ${member_list[i].LmPpChrgSn}`);		

			num++;	
		};		
		
		console.log(lemonPerson);
		console.log(lemonMembers);	
	}

	function connectRemoteMonster() {

		lemonPerson.connect();

		for (const key in lemonMembers) {

			lemonMembers[key].connect();
		}	
	}	

	function disConnectRemoteMonster() {

		lemonPerson.dis_connect();

		for (const key in lemonMembers) {

			lemonMembers[key].dis_connect();
		}
	}

	function getChannel(myName, destName) {

		return (myName > destName) ? myName + '_' + destName : destName + '_' + myName;
	}
	
	function exitWindowPop() {

		$('html').scrollTop(0);

		openPopup("live_exit_pop");		
	}

	function closeWindowPop() {

		$('html').scrollTop(0);

		openPopup("live_close_pop");		
	}

	// function getTimeStringSeconds(seconds){

	// 	var hour, min, sec

	// 	hour = parseInt(seconds/3600);

	// 	min = parseInt((seconds%3600)/60);

	// 	sec = seconds%60;

	// 	if (hour.toString().length==1) hour = "0" + hour;
	// 	if (min.toString().length==1) min = "0" + min;
	// 	if (sec.toString().length==1) sec = "0" + sec;

	// 	return hour + ":" + min + ":" + sec;
	// }
	
	$(document).ready(function() {

		initHtml(); 
	});	

	window.onload = function() {
		
		//alert( "인터뷰를 시작합니다.");

		initRemoteMonster();

		connectRemoteMonster();

		var hour = 0;
		var min = 0;
		var sec = 0;
		var time = 0;

		setInterval(function () {
			time++;

			min = Math.floor(time / 60);
			hour = Math.floor(min / 60);
			sec = time % 60;
			min = min % 60;

			var th = hour;
			var tm = min;
			var ts = sec;
			if (th < 10) {
				th = "0" + hour;
			}
			if (tm < 10) {
				tm = "0" + min;
			}
			if (ts < 10) {
				ts = "0" + sec;
			}

			document.getElementById("elapse_time").innerHTML = th + ":" + tm + ":" + ts;				
			//console.log(th + ":" + tm + ":" + ts);
		}, 1000);


		// Video
		// var video = document.getElementById("remoteVideo0");

		// console.log(video);

		// // Buttons		
		// var muteButton = document.getElementById("mute");
		
		// // Sliders		
		// var volumeBar = document.getElementById("volume-bar");

		// muteButton.addEventListener("click", function() {
		// if (video.muted == false) {
		// 	// Mute the video
		// 	video.muted = true;

		// 	// Update the button text
		// 	muteButton.innerHTML = "Unmute";

		// 	console.log("Unmute");
		// } else {
		// 	// Unmute the video
		// 	video.muted = false;

		// 	// Update the button text
		// 	muteButton.innerHTML = "Mute";
		// 	console.log("Mute");
		// }
		// });

		// volumeBar.addEventListener("change", function() {
		// 	// Update the video volume
		// 	video.volume = volumeBar.value;

		// 	console.log("volumeBar");
		// });
	}
		
	$(document).off("click", "#live_exit").on("click", "#live_exit", function (e) {

		$('html').scrollTop(0);

		openPopup("live_exit_pop");		
	});

	$(document).off("click", "#live_close").on("click", "#live_close", function (e) {

		$('html').scrollTop(0);

		openPopup("live_close_pop");
	});

	$(document).off("click", "#btn_live_exit").on("click", "#btn_live_exit", function (e) {

		disConnectRemoteMonster();

		ajaxExitProc("Exit");		
		// var returnValue = {
		//  	stat : "Exit",
		// 	recrut_sn: recrut_sn,
		// 	pp_mem_no: pp_mem_no,
		// 	live_sn: live_sn
		//  };
						
		// window.opener.getLiveItvResult(JSON.stringify(returnValue)); 	
	});

	$(document).off("click", "#btn_live_close").on("click", "#btn_live_close", function (e) {

		disConnectRemoteMonster();

		ajaxExitProc("Close");		
	});	
	
	// 기본 종료 버튼 눌렀을때.
	window.addEventListener("beforeunload", function (event) {

		disConnectRemoteMonster();

		var returnValue = {
		 	stat : "Force_Exit",
			recrut_sn: recrut_sn,
			pp_mem_no: pp_mem_no,
			live_sn: live_sn
		 };
						
		window.opener.getLiveItvResult(JSON.stringify(returnValue)); 		
	});
	
	function ajaxExitProc(exit_stat) {			

		var in_url = (exit_stat == "Exit" ? '/live/itv/exit' : '/live/itv/close');
		
		$.ajax({
			cache: false,
			url: in_url,
			data: {
					entp_mem_no: entp_mem_no,	
					entp_mem_sn: entp_mem_sn,	
					recrut_sn: recrut_sn,
					pp_mem_no: pp_mem_no,
					pp_mem_nm: pp_mem_nm,
					live_sn: live_sn
				},
				type: 'POST',
				dataType: "json",
				error: function (e) {
					console.log("error" + e);
				},
				success: function (rep) {
					var entp_mem_no = rep.LirEntpMemNo;	// 기업 회원 번호
					var recrut_sn = rep.LirRecrutSn;
					var pp_mem_no = rep.LirPpMemNo;
					var pp_mem_nm = rep.LirPpMemNm;
					var live_sn = rep.LirLiveSn;
					var entp_nm = rep.LirEntpNm;
					var name = rep.LirNm;
					var live_itv_sday = rep.LirLiveItvSday;
					var live_itv_stime = rep.LirLiveItvSTime;
					var live_itv_eday = rep.LirLiveItvEday;
					var live_itv_etime = rep.LirLiveItvETime;
					var live_itv_jt = rep.LirLiveItvJt;
					var sdt_tstmp = rep.LirSdtTstmp;
					
					// console.log("message(1) : " + JSON.stringify(rep));		

					// console.log("live_itv_sday: " + live_itv_sday);		
					// console.log("live_itv_stime: " + live_itv_stime);		
					// console.log("live_itv_eday: " + live_itv_eday);		
					// console.log("live_itv_etime: " + live_itv_etime);		
					// console.log("live_itv_jt: " + live_itv_jt);		
					// console.log("sdt_tstmp: " + sdt_tstmp);		

					//window.open("/ldk_test/a_test?live_sn="+live_sn);
					// var url = "/view//ldk_test/a_test.html";
					// var name = "popup test";
					// var option = "width = 500, height = 500, top = 100, left = 200, location = no";
					// window.open(url, name, option);		

					//openPopup("live_result_pop");			

					closePopup();

					// var popW = 1024
					// var popH = 1024
					// var popX = (screen.width / 2) - (popW/2)
					// var popY = (screen.height / 2) - (popH/2)

					//alert("<a>sdfsdfsafsdf</a><a>23424234234</>")
					//window.open("/live/inv/result?live_sn="+live_sn+"&recrut_sn="+recrut_sn+"&pp_mem_no="+pp_mem_no+"&pp_mem_nm="+pp_mem_nm,"_blank","width=" + popW + ",height=" + popH + ",left=" + popX + ",top=" + popY)

					//window.location.href = "/live/itv/result";

					//window.open(location, '_self').close();   
					// //openPopup("live_result_pop");			
					// var url = "popup.html";
					// var name = "popup test";
					// var option = "width = 500, height = 500, top = 100, left = 200, location = no"
					// window.open(url, name, option);			

					var returnValue = {
						stat : exit_stat,
						recrut_sn: recrut_sn,
						pp_mem_no: pp_mem_no,
						pp_mem_nm: pp_mem_nm,
						entp_nm: entp_nm,
						live_sn: live_sn,
						live_itv_sday: live_itv_sday,
						live_itv_stime: live_itv_stime,
						live_itv_eday: live_itv_eday,
						live_itv_etime: live_itv_etime,
						live_itv_jt: live_itv_jt,
						sdt_tstmp: sdt_tstmp
					};
					
					window.opener.getLiveItvResult(JSON.stringify(returnValue));
					window.open(location, '_self').close();						
				}
		});
	}

	// var vid = document.getElementById("myVideo");

	// function enableMute() { 
	// 	vid.muted = true;
	// }
</script>

{{end}} 